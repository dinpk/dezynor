<!doctype html>
<html>
	<head>
		<title>Import / Export - Dezynor</title>
		<link rel="stylesheet" href="includes/styles.css?v=20220722">
		<script src="includes/indexeddb.js"></script>
		<script src="includes/common.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>			
		<script>

			async function exportData() {

				let progress_bar = document.getElementById("progress_bar");
				progress_bar.style.visibility = "visible";
				
				let zip_items = new JSZip();

				let all_settings = await idbGetAllItems("dezynor_settings");
				zip_items.file("settings.backup", JSON.stringify(all_settings));
			
				let all_designs = await idbGetAllItems("dezynor_designs");
				let total_exported = all_designs.length;
				for (i = 0; i < total_exported; i++) {
					zip_items.file(all_designs[i].design_key + ".backup", JSON.stringify(all_designs[i].value));
				}

				let all_images = await idbGetAllItems("dezynor_images");
				for (i = 0; i < all_images.length; i++) {
					zip_items.file(all_images[i].image_key + ".backup", all_images[i].value);
				}

				let file_name = "dezynor-backup-" + new Date().toISOString().replace("T", "-").replaceAll(":", "-").slice(0,19);
				zip_items.generateAsync({type:"blob",
					compression: "DEFLATE",
					compressionOptions: {
						level: 9 /* 1 (best speed) to 9 (best compression) */
					}}).then(function(content) {
						saveAs(content, file_name + ".zip");
						progress_bar.style.visibility = "hidden";
						document.getElementById("message").innerHTML = "<div class='pad20'>Exported " + total_exported + " designs.</div>";
					});
				
			}



			let total_files = 0;
			let total_imported = 0;
			
			function importData() {
			
				let import_files = document.getElementById("import_files").files;
				if (import_files.length == 0) return;
				
				total_files = import_files.length; // exclude setting file

				document.getElementById("progress_bar").style.visibility = "visible";
				
				Array.from(import_files).forEach(file => {
					
					let reader = new FileReader();
					reader.onload = async function(e) {
						let file_name = file.name;
						let file_data = e.target.result;
						
						if (file_name.indexOf("dezyn-") == 0) {
							let key = file_name.replace(".backup", "");
							let object = JSON.parse(file_data);
							console.log(key);
							if (await idbPutItem("dezynor_designs", {design_key:key, value:object})) {
								total_imported++;
								showProgress();
							}

						} else if (file_name.indexOf("image-") == 0) {
							let key_of_image = file_name.replace(".backup", "");
							let new_blob = dataURItoBlob(file_data);
							if (await idbPutItem("dezynor_images", {image_key:key_of_image, value:new_blob})) {
								total_imported++;
								showProgress();
							}
						} else if (file_name == "settings.backup") {
							let settings = JSON.parse(file_data);
							total_files = total_files + settings.length - 1;
							for (i = 0; i < settings.length; i++) {
								let key_of_setting = settings[i].setting_key;
								let value_of_setting = settings[i].value;
								if (await idbPutItem("dezynor_settings", {setting_key:key_of_setting, value: value_of_setting})) {
									total_imported++;
									showProgress();
								}
							}
						}
						
					}
					reader.readAsText(file);
				});

				let timer = setInterval(function() {
					if (total_files == total_imported) {
						document.getElementById("message").innerHTML = "<div class='pad20'>Imported data successfully.</div>";
						total_files = 0;
						total_imported = 0;
						document.getElementById("progress_bar").style.visibility = "hidden";
						document.getElementById("import_files").value = "";
						clearInterval(timer);
					}
				}, 1000);
			}
			
			function showProgress() {
				document.getElementById("message").innerHTML = "<div class='pad20'>Importing " + total_imported + " of " + total_files + "</div>";
			}
			
			function dataURItoBlob(dataURI) {
				var byteString = atob(dataURI.split(',')[1]);
				var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0]
				var ab = new ArrayBuffer(byteString.length);
				var ia = new Uint8Array(ab);
				for (var i = 0; i < byteString.length; i++) {
					ia[i] = byteString.charCodeAt(i);
				}
				var blob = new Blob([ab], {type: mimeString});
				return blob;
			}		
							
		</script>
	</head>
	<body>
		<script>writeHeader();</script>
		<div id="message"></div>
		<div id="progress_bar" class="padleft20" style="visibility:hidden"><progress></progress></div>				
		<div class="pad20">
			<input type="button" value="Export data" onclick="exportData();">
			<br><br>
			<input type="file" name="import_files" id="import_files" accept=".backup" onchange="importData();" multiple style="display:none;">
			<input type="button" value="Import data" onclick="document.getElementById('import_files').click();">
		</div>

	</body>
</html>

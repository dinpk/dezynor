<!doctype html>
<html>
	<head>
		<title>Import / Export - Dezynor</title>
		<style>
			#importexport-table {
				margin:20px 0 0 50px;
				line-height:300%;
			}
		</style>
		<script src="includes/indexeddb.js"></script>
		<script src="includes/common.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>			
		<script>

			async function exportData() {

				let progress_bar = document.getElementById("progress_bar");
				progress_bar.style.visibility = "visible";
				
				let zip_items = new JSZip();

				let all_settings = await idbGetAllItems("dezynor_settings");
				zip_items.file("settings.backup", JSON.stringify(all_settings));
			
				let all_designs = await idbGetAllItems("dezynor_designs");
				for (i = 0; i < all_designs.length; i++) {
					zip_items.file(all_designs[i].design_key + ".backup", all_designs[i].value);
				}

				let all_images = await idbGetAllItems("dezynor_images");
				for (i = 0; i < all_images.length; i++) {
					zip_items.file(all_images[i].image_key + ".backup", all_images[i].value);
				}

				let file_name = "dezynor-backup-" + new Date().toISOString().replace("T", "-").replaceAll(":", "-").slice(0,19);
				zip_items.generateAsync({type:"blob",
					compression: "DEFLATE",
					compressionOptions: {
						level: 9 /* 1 (best speed) to 9 (best compression) */
					}}).then(function(content) {
						saveAs(content, file_name + ".zip");
						progress_bar.style.visibility = "hidden";
						document.getElementById("message").innerHTML = "Exported data successfully";
					});
				
			}
				
			function importData() {
				
				let backup_files = document.getElementById('backup_files').files;
				
				if (backup_files.length == 0) return;
				
				let progress_bar = document.getElementById("progress_bar");
				progress_bar.style.visibility = "visible";
				
				
				Array.from(backup_files).forEach(file => {
					
					let reader = new FileReader();
					reader.onload = async function(e) {
						
						let file_name = file.name;
						let file_data = e.target.result;
						
						// import settings
						if (file_name == "settings.backup") {
							let settings = JSON.parse(file_data);
							for (i = 0; i < settings.length; i++) {
								// console.log(settings[i].setting_key + " - " + settings[i].value);
								let key_of_setting = settings[i].setting_key;
								let value_of_setting = settings[i].value;
								idbPutItem("dezynor_settings", {setting_key:key_of_setting, value: value_of_setting});
							}
						}
						// import designs
						if (file_name.indexOf("dezyn-") == 0) {
							let key_of_design = file_name.replace(".backup", "");
							idbPutItem("dezynor_designs", {design_key:key_of_design, value: file_data});
						}
						
					}
					
					reader.readAsText(file);
				});



				// import images
				Array.from(backup_files).forEach(file => {
					
					let reader = new FileReader();
					reader.onload = async function(e) {
						
						let file_name = file.name;
						let file_data = e.target.result;

						if (file_name.indexOf("image-") == 0) {
							let key_of_image = file_name.replace(".backup", "");
							let new_blob = dataURItoBlob(file_data);
							idbPutItem("dezynor_images", {image_key:key_of_image, value:new_blob});
						}
						
						progress_bar.style.visibility = "hidden";
						document.getElementById("backup_files").value = "";
						document.getElementById("message").innerHTML = "Imported data successfully";
					}
					reader.readAsDataURL(file);
				});

			}
			
			function dataURItoBlob(dataURI) {
				var byteString = atob(dataURI.split(',')[1]);
				var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0]
				var ab = new ArrayBuffer(byteString.length);
				var ia = new Uint8Array(ab);
				for (var i = 0; i < byteString.length; i++) {
					ia[i] = byteString.charCodeAt(i);
				}
				var blob = new Blob([ab], {type: mimeString});
				return blob;
			}		
				

		</script>
	</head>
	<body>
		
		<script>writeHeader();</script>
		
		<div id="message"></div>
		
		<table id="importexport-table">
			<tr>
				<td>Export data</td>
				<td><input type="button" value="Export" onclick="exportData();"></td>
			</tr>
			<tr>
				<td>Import data</td>
				<td><input type="file" name="backup_files" id="backup_files" accept=".backup" onchange="importData();" multiple></td>
			</tr>
			<tr>
				<td></td>
				<td>
					<div id="progress_bar" style="visibility:hidden">
						<progress></progress>
					</div>				
				</td>
			</tr>
		</table>
	</body>
</html>
